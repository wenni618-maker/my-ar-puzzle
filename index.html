<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <style>
        body { margin: 0; background: #000; color: #0f0; font-family: monospace; overflow: hidden; }
        #start-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #222; z-index: 10000; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
        }
        button {
            padding: 20px 40px; font-size: 1.2rem; background: #0f0;
            border: none; border-radius: 50px; cursor: pointer; font-weight: bold;
        }
        #ui { position: fixed; top: 10px; left: 10px; z-index: 1000; display: none; background: rgba(0,0,0,0.8); padding: 10px; border: 1px solid #0f0; }
    </style>
</head>
<body>

    <div id="start-screen">
        <p>準備進入 AR 修復空間</p>
        <button id="go">點此開啟相機</button>
        <p id="err" style="color:red; margin-top:20px;"></p>
    </div>

    <div id="ui">X: <span id="valX">0</span> | Y: <span id="valY">0</span></div>

    <a-scene mindar-image="imageTargetSrc: targets.mind; autoStart: false;" embedded vr-mode-ui="enabled: false">
        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
        <a-entity mindar-image-target="targetIndex: 0">
            <a-sphere position="0 0 0" radius="0.05" color="red"></a-sphere>
            <a-image id="part1" src="part1.png" position="0 0 0.1" scale="0.5 0.5 0.5"></a-image>
        </a-entity>
    </a-scene>

    <script>
        const goBtn = document.getElementById('go');
        const errTxt = document.getElementById('err');
        const sceneEl = document.querySelector('a-scene');

        goBtn.addEventListener('click', () => {
            // 1. 先嘗試請求相機權限
            navigator.mediaDevices.getUserMedia({ video: true })
            .then(() => {
                // 2. 如果相機權限 OK，再啟動 AR 系統
                document.getElementById('start-screen').style.display = 'none';
                document.getElementById('ui').style.display = 'block';
                
                const arSystem = sceneEl.systems["mindar-image-system"];
                arSystem.start(); 
            })
            .catch((err) => {
                errTxt.innerText = "無法開啟相機：" + err.message + "\n請在手機設定中允許 Chrome 使用相機。";
            });
        });

        // 座標採集邏輯
        window.addEventListener('touchmove', (e) => {
            let touch = e.touches[0];
            let x = (touch.clientX / window.innerWidth) * 2 - 1;
            let y = -(touch.clientY / window.innerHeight) * 2 + 1;
            let finalX = (x * 1.5).toFixed(2);
            let finalY = (y * 1.5).toFixed(2);
            document.getElementById('part1').setAttribute('position', `${finalX} ${finalY} 0.05`);
            document.getElementById('valX').innerText = finalX;
            document.getElementById('valY').innerText = finalY;
        });
    </script>
</body>
</html>