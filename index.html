<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>水墨碎片修復</title>
    <style>
        body { margin: 0; padding: 0; background-color: #f4f4f4; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; font-family: sans-serif; }
        
        #game-container { 
            position: relative; 
            width: 90vw; 
            height: 90vh; 
            max-width: 1000px; 
            max-height: 800px; 
            background-image: url('bg.jpg'); 
            background-size: contain; 
            background-repeat: no-repeat; 
            background-position: center; 
            border: 2px solid #ccc; 
            background-color: white; 
        }

        .piece { 
            position: absolute; 
            cursor: grab; 
            touch-action: none; 
            z-index: 10;
            /* ✨ 預設白光效果 */
            filter: drop-shadow(0px 0px 0px rgba(255, 255, 255, 0.9));
            
        }
        
        /* ✨ 關鍵修改：當拼圖被按住拖動時，關閉過渡效果防止「白光暫留」 */
        .piece:active { 
            cursor: grabbing; 
            z-index: 100;
            transform: scale(1.15); /* 拖動時稍微放大增加手感 */
            filter: drop-shadow(0px 0px 0px rgba(255, 255, 255, 1)); /* 拖動時光芒變亮 */
            transition: none !important; 
        }

        /* ✨ 成功吸附後：白光完全消失 */
        .piece.locked { 
            filter: drop-shadow(0px 0px 0px rgba(255, 255, 255, 0));
            z-index: 1;
            pointer-events: none;
            opacity: 1;
            transform: scale(1);
            transition: filter 0.4s ease; /* 吸附時光暈平滑淡出 */
        }

        #debug { position: fixed; top: 10px; left: 10px; background: rgba(0,0,0,0.8); color: #0f0; padding: 10px; font-size: 12px; pointer-events: none; z-index: 1000; border-radius: 5px; }
        #message { position: fixed; bottom: 20px; color: #333; font-weight: bold; background: white; padding: 8px 20px; border-radius: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 1000; }
    </style>
</head>
<body>

    <div id="debug">對位工具模式<br>X: 0%, Y: 0%</div>
    <div id="message">將碎片拖動至正確位置</div>

    <div id="game-container">
        <img src="piece1.png" id="p1" class="piece" style="width: 16.5%; left: 5%; top: 2%;" data-target-x="43.8" data-target-y="26.2">
        <img src="piece2.png" id="p2" class="piece" style="width: 15.1%; left: 25%; top: 3.5%;" data-target-x="50" data-target-y="39.1">
        <img src="piece3.png" id="p3" class="piece" style="width: 9.3%; left: 45%; top: 3.5%;" data-target-x="18.6" data-target-y="27">
        <img src="piece4.png" id="p4" class="piece" style="width: 12.1%; left: 60%; top: 3.5%;" data-target-x="34.1" data-target-y="43.2">
        <img src="piece5.png" id="p5" class="piece" style="width: 20.53%; left: 75%; top: 3.5%;" data-target-x="15.4" data-target-y="41.2">
        <img src="piece6.png" id="p6" class="piece" style="width: 12.65%; left: 5%; top: 88%;" data-target-x="34.9" data-target-y="58.8">
        <img src="piece7.png" id="p7" class="piece" style="width: 16.4%; left: 25%; top: 88%;" data-target-x="9.7" data-target-y="53.5">
        <img src="piece8.png" id="p8" class="piece" style="width: 11%; left: 45%; top: 85%;" data-target-x="60.9" data-target-y="61.3">
        <img src="piece9.png" id="p9" class="piece" style="width: 16.5%; left: 60%; top: 85%;" data-target-x="25.1" data-target-y="72.6">
    </div>

    <script>
        const container = document.getElementById('game-container');
        const debug = document.getElementById('debug');
        let activePiece = null;

        document.querySelectorAll('.piece').forEach(piece => {
            piece.onpointerdown = function(e) {
                if(piece.classList.contains('locked')) return;
                activePiece = piece;
                piece.setPointerCapture(e.pointerId);
            };

            piece.onpointermove = function(e) {
                if (!activePiece) return;
                
                const rect = container.getBoundingClientRect();
                let x = ((e.clientX - rect.left) / rect.width) * 100;
                let y = ((e.clientY - rect.top) / rect.height) * 100;

                const pWidth = parseFloat(activePiece.style.width);
                const pHeight = (activePiece.offsetHeight / rect.height) * 100;

                activePiece.style.left = (x - pWidth/2) + '%';
                activePiece.style.top = (y - pHeight/2) + '%';

                debug.innerHTML = `正在調整: ${activePiece.id}<br>當前 X: ${x.toFixed(1)}%<br>當前 Y: ${y.toFixed(1)}%`;
            };

            piece.onpointerup = function(e) {
                if (!activePiece) return;
                
                const rect = container.getBoundingClientRect();
                const pWidth = parseFloat(activePiece.style.width);
                const pHeight = (activePiece.offsetHeight / rect.height) * 100;

                const currentX = parseFloat(activePiece.style.left) + pWidth/2;
                const currentY = parseFloat(activePiece.style.top) + pHeight/2;
                
                const targetX = parseFloat(activePiece.getAttribute('data-target-x'));
                const targetY = parseFloat(activePiece.getAttribute('data-target-y'));

                const distance = Math.sqrt(Math.pow(currentX - targetX, 2) + Math.pow(currentY - targetY, 2));

                if (distance < 4) { 
                    activePiece.style.left = (targetX - pWidth/2) + '%';
                    activePiece.style.top = (targetY - pHeight/2) + '%';
                    activePiece.classList.add('locked');
                    checkWin();
                }
                
                activePiece = null;
            };
        });

        function checkWin() {
            const lockedPieces = document.querySelectorAll('.piece.locked').length;
            if (lockedPieces === 9) {
                document.getElementById('message').innerText = "恭喜完成！水墨畫完美呈現。";
                document.getElementById('message').style.color = "green";
                document.getElementById('message').style.backgroundColor = "#e8f5e9";
            }
        }
    </script>
</body>
</html>