<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; color: #00FF00; font-family: monospace; }
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        button { padding: 15px 30px; font-size: 18px; background: #00FF00; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        #ui { position: fixed; top: 10px; left: 10px; z-index: 1000; background: rgba(0,0,0,0.7); padding: 10px; border: 1px solid #00FF00; display: none; }
    </style>
</head>
<body>

    <div id="overlay">
        <div id="msg">正在下載資源，請稍候...</div>
        <button id="startBtn" style="display:none;">點此啟動 AR 修復之旅</button>
    </div>

    <div id="ui">
        座標採集模式：<br>
        X: <span id="valX">0.00</span> | Y: <span id="valY">0.00</span>
    </div>

    <a-scene 
        mindar-image="imageTargetSrc: targets.mind; autoStart: false; uiLoading: no; uiScanning: yes;" 
        embedded vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">
        
        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <a-entity mindar-image-target="targetIndex: 0">
            <a-sphere position="0 0 0" radius="0.05" color="red"></a-sphere>
            <a-image id="part1" src="part1.png" position="0 0 0.1" scale="0.4 0.4 0.4"></a-image>
            <a-image src="MissingPartScene.png" position="0 0 0" opacity="0.3"></a-image>
        </a-entity>
    </a-scene>

    <script>
        const sceneEl = document.querySelector('a-scene');
        const overlay = document.getElementById('overlay');
        const startBtn = document.getElementById('startBtn');
        const msg = document.getElementById('msg');
        const ui = document.getElementById('ui');

        // 等待場景與引擎加載完成
        sceneEl.addEventListener('renderstart', () => {
            msg.innerText = "資源載入完成！";
            startBtn.style.display = "block";
        });

        async function startAR() {
            overlay.style.display = "none";
            ui.style.display = "block";
            
            const arSystem = sceneEl.systems["mindar-image-system"];
            if (arSystem) {
                try {
                    await arSystem.start();
                } catch (e) {
                    alert("啟動錯誤: " + e.message);
                }
            } else {
                alert("AR 系統初始化失敗，請檢查 targets.mind 是否正確。");
            }
        }

        startBtn.onclick = startAR;

        // 拖曳邏輯
        window.addEventListener('touchmove', (e) => {
            let touch = e.touches[0];
            let x = (touch.clientX / window.innerWidth) * 2 - 1;
            let y = -(touch.clientY / window.innerHeight) * 2 + 1;
            let finalX = (x * 1.5).toFixed(2);
            let finalY = (y * 1.5).toFixed(2);
            
            const part1 = document.getElementById('part1');
            part1.setAttribute('position', `${finalX} ${finalY} 0.05`);
            document.getElementById('valX').innerText = finalX;
            document.getElementById('valY').innerText = finalY;
        });
    </script>
</body>
</html>