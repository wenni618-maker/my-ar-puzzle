<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>水墨碎片修復</title>
    <style>
        body { margin: 0; padding: 0; display: flex; justify-content: center; align-items: center; height: 100vh; width: 100vw; overflow: hidden; font-family: sans-serif; background-color: #1a1a1a; }
        #game-container { position: relative; width: 100%; height: 100%; max-width: calc(100vh * (190 / 260)); max-height: calc(100vw * (260 / 190)); aspect-ratio: 190 / 260; background-image: url('bg.jpg'); background-size: contain; background-repeat: no-repeat; background-position: center; background-color: #ccc; margin: auto; box-shadow: 0 0 50px rgba(0,0,0,0.8); }
        .piece { position: absolute; cursor: grab; touch-action: none; z-index: 10; transform: translate(-50%, -50%); }
        .piece:active { cursor: grabbing; z-index: 100; transform: translate(-50%, -50%) scale(1.15); filter: drop-shadow(0px 0px 8px rgba(255, 255, 255, 1)); }
        .piece.locked { filter: none; z-index: 1; pointer-events: none; transform: translate(-50%, -50%) scale(1); transition: all 0.4s ease; }
        #complete-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url('complete.jpg'); background-size: contain; background-repeat: no-repeat; background-position: center; background-color: white; z-index: 2000; display: none; opacity: 0; transition: opacity 2s ease-in-out; justify-content: center; align-items: center; }
        #complete-banner { width: 100%; background-color: rgba(255, 255, 255, 0.85); padding: 20px 0; text-align: center; opacity: 0; transform: translateY(10px); transition: opacity 1s ease-out, transform 1s ease-out; transition-delay: 0.6s; }
        #complete-text { font-size: 2rem; color: #1a1a1a; font-weight: bold; letter-spacing: 10px; }
        #message { position: fixed; bottom: 4%; color: white; background: rgba(0,0,0,0.6); padding: 8px 20px; border-radius: 30px; z-index: 1000; pointer-events: none; font-size: 13px; }

	    </style>
</head>
<body>
<button id="btn-close" style="position:fixed; top:10px; right:10px; z-index:9999; width:40px; height:40px; border-radius:50%; background:white; border:none; font-size:20px; font-weight:bold;">✕</button>

    <div id="message">將碎片拖動至正確位置</div>
    <div id="game-container">
        <div id="complete-overlay"><div id="complete-banner"><div id="complete-text">修復完成</div></div></div>
        <img src="piece1.png" id="p1" class="piece" style="width: 16.5%; left: 10%; top: 15%;" data-target-x="43.8" data-target-y="31.3">
        <img src="piece2.png" id="p2" class="piece" style="width: 15.1%; left: 30%; top: 15%;" data-target-x="50.1" data-target-y="41.4">
        <img src="piece3.png" id="p3" class="piece" style="width: 9.3%; left: 50%; top: 15%;" data-target-x="18.6" data-target-y="31.9">
        <img src="piece4.png" id="p4" class="piece" style="width: 12.1%; left: 70%; top: 15%;" data-target-x="34.2" data-target-y="44.6">
        <img src="piece5.png" id="p5" class="piece" style="width: 20.53%; left: 90%; top: 15%;" data-target-x="15.3" data-target-y="43">
        <img src="piece6.png" id="p6" class="piece" style="width: 12.65%; left: 15%; top: 85%;" data-target-x="34.9" data-target-y="57.1">
        <img src="piece7.png" id="p7" class="piece" style="width: 16.4%; left: 35%; top: 85%;" data-target-x="9.5" data-target-y="52.7">
        <img src="piece8.png" id="p8" class="piece" style="width: 11%; left: 55%; top: 85%;" data-target-x="60.9" data-target-y="59">
        <img src="piece9.png" id="p9" class="piece" style="width: 16.5%; left: 80%; top: 85%;" data-target-x="25.1" data-target-y="67.9">
    </div>

    <script>
        // --- 旋轉偵測：若寬大於高(橫向)，跳回 index.html ---
        function checkOrientation() {
            if (window.innerWidth > window.innerHeight) {
                window.location.replace("index.html");
            }
        }
        window.addEventListener("resize", checkOrientation);

        const container = document.getElementById('game-container');
        let activePiece = null;

        document.querySelectorAll('.piece').forEach(piece => {
            piece.onpointerdown = function(e) {
                if(piece.classList.contains('locked')) return;
                activePiece = piece;
                piece.setPointerCapture(e.pointerId);
            };
            piece.onpointermove = function(e) {
                if (!activePiece) return;
                const rect = container.getBoundingClientRect();
                activePiece.style.left = (((e.clientX - rect.left) / rect.width) * 100) + '%';
                activePiece.style.top = (((e.clientY - rect.top) / rect.height) * 100) + '%';
            };
            piece.onpointerup = function(e) {
                if (!activePiece) return;
                const currentX = parseFloat(activePiece.style.left);
                const currentY = parseFloat(activePiece.style.top);
                const targetX = parseFloat(activePiece.getAttribute('data-target-x'));
                const targetY = parseFloat(activePiece.getAttribute('data-target-y'));
                if (Math.sqrt(Math.pow(currentX - targetX, 2) + Math.pow(currentY - targetY, 2)) < 5) { 
                    activePiece.style.left = targetX + '%';
                    activePiece.style.top = targetY + '%';
                    activePiece.classList.add('locked');
                    checkWin();
                }
                activePiece = null;
            };
        });

        function checkWin() {
            if (document.querySelectorAll('.piece.locked').length === 9) {
                const overlay = document.getElementById('complete-overlay');
                const banner = document.getElementById('complete-banner');
                overlay.style.display = 'flex';
                setTimeout(() => { overlay.style.opacity = '1'; banner.style.opacity = '1'; banner.style.transform = 'translateY(0)'; }, 100);
            }
        }

 document.getElementById('btn-close').onclick = function() {
    // 告訴父視窗 (AR 主控台) 關閉這個遊戲層
    window.parent.postMessage('closeGame', '*');
};

    </script>

</body>
</html>